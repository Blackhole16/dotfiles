#!/bin/bash

UUID="8dc510f4-6bb0-4c2c-8594-d1cbecc49f91"
DEVICE="/dev/disk/by-uuid/$UUID"

run_hook() {
  if [ ! -e $DEVICE ]
      then
          echo -n No Keyfiles found -- please insert USB-Drive and press return...
          read
  fi

  if [ ! -e $DEVICE ]
      then
          echo -n pre-poweroff
          read
          poweroff
    echo -n post-poweroff, pre-shutdown -P
    read
    shutdown -P now "No Keyfile found"
    echo -n post-shutdown, fucked up
    read
  fi

  cryptsetup -T 3 open $DEVICE keys
  mkdir /keys
  mount /dev/mapper/keys /keys
  ln -s /keys/keyfile_system /crypto_keyfile.bin
}

run_latehook() {
  cryptsetup open -d /keys/keyfile_swap /dev/nvme0n1p6 swap
  umount /keys
  cryptsetup close keys
  rm -r /keys
}

